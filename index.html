<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 dark:bg-gradient-to-br dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 min-h-screen p-4 transition-colors duration-300">
    <div class="max-w-7xl mx-auto">
        <!-- Cabeçalho com Modo Escuro -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white">Controle de Gastos</h1>
            <button id="darkModeToggle" class="bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white rounded-full p-3 shadow-lg transition-all duration-300 hover:scale-110">
                <svg id="darkModeIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path id="moonIcon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    <path id="sunIcon" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
            </button>
        </div>

        <!-- NOVO: Painel de Orçamento/Saldo -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-blue-900/40 dark:to-indigo-900/40 rounded-2xl shadow-xl p-6 mb-6 border-2 border-blue-300 dark:border-blue-700">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Orçamento Mensal</h2>
                    
                    <!-- Configurar Orçamento -->
                    <div class="flex gap-3 mb-4">
                        <input type="number" id="budgetInput" placeholder="Digite seu orçamento mensal" step="0.01"
                               class="flex-1 border-2 border-blue-300 dark:border-blue-600 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                        <button onclick="setBudget()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl px-6 py-2 transition-all duration-300 hover:scale-105">
                            Definir
                        </button>
                    </div>

                    <!-- Exibição de Valores -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-300 font-semibold">Orçamento</p>
                            <p id="budgetTotal" class="text-2xl font-bold text-blue-700 dark:text-blue-300">R$ 0,00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-300 font-semibold">Gasto</p>
                            <p id="budgetSpent" class="text-2xl font-bold text-orange-700 dark:text-orange-300">R$ 0,00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-300 font-semibold">Saldo</p>
                            <p id="budgetRemaining" class="text-2xl font-bold text-green-700 dark:text-green-300">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <!-- Barra de Progresso Visual -->
                <div class="flex-1">
                    <div class="mb-2 flex justify-between text-sm font-semibold text-gray-700 dark:text-gray-200">
                        <span>Progresso de Gastos</span>
                        <span id="budgetPercentage">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-8 overflow-hidden">
                        <div id="budgetBar" class="h-full bg-gradient-to-r from-green-500 to-blue-500 transition-all duration-500 flex items-center justify-center text-white font-bold text-sm" style="width: 0%">
                            <span id="budgetBarText"></span>
                        </div>
                    </div>
                    <p id="budgetStatus" class="text-sm text-gray-600 dark:text-gray-300 mt-2 text-center font-medium"></p>
                </div>
            </div>
        </div>
        
        <!-- Formulário de Adicionar Gasto -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 mb-6 border border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">Adicionar Novo Gasto</h2>
            <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <input type="text" id="description" placeholder="Descrição do gasto" required 
                       class="border-2 border-gray-300 dark:border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                <input type="number" id="amount" placeholder="Valor (R$)" step="0.01" required 
                       class="border-2 border-gray-300 dark:border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                <select id="category" required 
                        class="border-2 border-gray-300 dark:border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="">Selecione a categoria</option>
                    <option value="Alimentação">Alimentação</option>
                    <option value="Transporte">Transporte</option>
                    <option value="Saúde">Saúde</option>
                    <option value="Lazer">Lazer</option>
                    <option value="Educação">Educação</option>
                    <option value="Moradia">Moradia</option>
                    <option value="Outros">Outros</option>
                </select>
                <input type="date" id="date" required 
                       class="border-2 border-gray-300 dark:border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                <button type="submit" 
                        class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-xl px-6 py-3 transition-all duration-300 hover:scale-105 shadow-md">
                    Adicionar
                </button>
            </form>
        </div>

        <!-- Resumo de Gastos -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900/40 dark:to-red-800/40 rounded-2xl shadow-lg p-6 border-2 border-red-200 dark:border-red-700">
                <h3 class="text-gray-700 dark:text-gray-200 text-sm font-bold mb-2 uppercase tracking-wide">Total Gasto</h3>
                <p class="text-4xl font-bold text-red-700 dark:text-red-300" id="totalExpense">R$ 0,00</p>
            </div>
            <div class="bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/40 dark:to-orange-800/40 rounded-2xl shadow-lg p-6 border-2 border-orange-200 dark:border-orange-700">
                <h3 class="text-gray-700 dark:text-gray-200 text-sm font-bold mb-2 uppercase tracking-wide">Gastos Este Mês</h3>
                <p class="text-4xl font-bold text-orange-700 dark:text-orange-300" id="monthExpense">R$ 0,00</p>
            </div>
            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-900/40 dark:to-yellow-800/40 rounded-2xl shadow-lg p-6 border-2 border-yellow-200 dark:border-yellow-700">
                <h3 class="text-gray-700 dark:text-gray-200 text-sm font-bold mb-2 uppercase tracking-wide">Gastos Hoje</h3>
                <p class="text-4xl font-bold text-yellow-700 dark:text-yellow-300" id="todayExpense">R$ 0,00</p>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Gastos por Categoria</h3>
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Gastos por Dia (Últimos 7 dias)</h3>
                <canvas id="dailyChart"></canvas>
            </div>
        </div>

        <!-- Modal de Dia Detalhado -->
        <div id="dayModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 id="modalDayTitle" class="text-2xl font-bold"></h3>
                            <p id="modalDaySubtitle" class="text-indigo-100 mt-1"></p>
                        </div>
                        <button onclick="closeDayModal()" class="text-white hover:text-gray-200 text-3xl font-bold leading-none">&times;</button>
                    </div>
                    <div class="mt-4">
                        <p class="text-sm text-indigo-100">Total do dia</p>
                        <p id="modalDayTotal" class="text-3xl font-bold"></p>
                    </div>
                </div>
                <div id="modalDayExpenses" class="p-6 overflow-y-auto max-h-96"></div>
            </div>
        </div>

        <!-- Calendário e Lista de Gastos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Calendário -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Calendário de Gastos</h3>
                <div id="calendar" class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prevMonth" class="bg-indigo-100 hover:bg-indigo-200 dark:bg-indigo-800 dark:hover:bg-indigo-700 rounded-lg px-4 py-2 text-gray-900 dark:text-white transition-all duration-300 font-semibold">Anterior</button>
                        <h4 id="currentMonth" class="text-lg font-bold text-gray-900 dark:text-white capitalize"></h4>
                        <button id="nextMonth" class="bg-indigo-100 hover:bg-indigo-200 dark:bg-indigo-800 dark:hover:bg-indigo-700 rounded-lg px-4 py-2 text-gray-900 dark:text-white transition-all duration-300 font-semibold">Próximo</button>
                    </div>
                    <div class="grid grid-cols-7 gap-2 text-center mb-2">
                        <div class="font-bold text-gray-900 dark:text-gray-100 text-sm">Dom</div>
                        <div class="font-bold text-gray-900 dark:text-gray-100 text-sm">Seg</div>
                        <div class="font-bold text-gray-900 dark:text-gray-100 text-sm">Ter</div>
                        <div class="font-bold text-gray-900 dark:text-gray-100 text-sm">Qua</div>
                        <div class="font-bold text-gray-900 dark:text-gray-100 text-sm">Qui</div>
                        <div class="font-bold text-gray-900 dark:text-gray-100 text-sm">Sex</div>
                        <div class="font-bold text-gray-900 dark:text-gray-100 text-sm">Sáb</div>
                    </div>
                    <div id="calendarDays" class="grid grid-cols-7 gap-2 text-center"></div>
                </div>
            </div>

            <!-- Lista de Gastos -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Lista de Gastos</h3>
                <div id="expenseList" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>

    <script>
        // Estado global
        let expenses = [];
        let currentDate = new Date();
        let categoryChart = null;
        let dailyChart = null;
        let monthlyBudget = 0;

        // CONTINUA NO CÓDIGO 2...

// CONTINUAÇÃO DO CÓDIGO DA PARTE 1

// ===== FUNÇÕES DE ORÇAMENTO =====

function loadBudget() {
    const stored = localStorage.getItem('monthlyBudget');
    if (stored) {
        monthlyBudget = parseFloat(stored);
        console.log('Orçamento carregado:', monthlyBudget);
    }
}

function saveBudget() {
    localStorage.setItem('monthlyBudget', monthlyBudget.toString());
    console.log('Orçamento salvo:', monthlyBudget);
}

function setBudget() {
    const input = document.getElementById('budgetInput');
    const value = parseFloat(input.value);
    
    if (isNaN(value) || value <= 0) {
        alert('Por favor, digite um valor válido para o orçamento!');
        return;
    }
    
    monthlyBudget = value;
    saveBudget();
    updateBudgetDisplay();
    input.value = '';
    
    // Feedback visual
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'Definido!';
    btn.classList.add('!bg-green-600');
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('!bg-green-600');
    }, 2000);
}

function updateBudgetDisplay() {
    // Calcular gastos do mês atual
    const now = new Date();
    const monthExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date + 'T00:00:00');
        return expenseDate.getMonth() === now.getMonth() && 
               expenseDate.getFullYear() === now.getFullYear();
    });
    
    const totalSpent = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
    const remaining = monthlyBudget - totalSpent;
    const percentage = monthlyBudget > 0 ? Math.min((totalSpent / monthlyBudget) * 100, 100) : 0;
    
    // Atualizar textos
    document.getElementById('budgetTotal').textContent = `R$ ${monthlyBudget.toFixed(2).replace('.', ',')}`;
    document.getElementById('budgetSpent').textContent = `R$ ${totalSpent.toFixed(2).replace('.', ',')}`;
    document.getElementById('budgetRemaining').textContent = `R$ ${remaining.toFixed(2).replace('.', ',')}`;
    document.getElementById('budgetPercentage').textContent = `${percentage.toFixed(1)}%`;
    
    // Atualizar barra de progresso
    const bar = document.getElementById('budgetBar');
    const barText = document.getElementById('budgetBarText');
    const status = document.getElementById('budgetStatus');
    
    bar.style.width = `${percentage}%`;
    
    // Mudar cores baseado na porcentagem
    if (percentage >= 100) {
        bar.className = 'h-full bg-gradient-to-r from-red-600 to-red-700 transition-all duration-500 flex items-center justify-center text-white font-bold text-sm';
        status.textContent = '⚠️ Orçamento excedido!';
        status.className = 'text-sm text-red-600 dark:text-red-400 mt-2 text-center font-bold';
        barText.textContent = 'LIMITE EXCEDIDO';
        document.getElementById('budgetRemaining').classList.add('text-red-700', 'dark:text-red-300');
        document.getElementById('budgetRemaining').classList.remove('text-green-700', 'dark:text-green-300');
    } else if (percentage >= 80) {
        bar.className = 'h-full bg-gradient-to-r from-orange-500 to-red-500 transition-all duration-500 flex items-center justify-center text-white font-bold text-sm';
        status.textContent = '⚠️ Atenção! Você gastou mais de 80% do orçamento';
        status.className = 'text-sm text-orange-600 dark:text-orange-400 mt-2 text-center font-semibold';
        barText.textContent = `${percentage.toFixed(0)}%`;
        document.getElementById('budgetRemaining').classList.add('text-orange-700', 'dark:text-orange-300');
        document.getElementById('budgetRemaining').classList.remove('text-green-700', 'dark:text-green-300');
    } else if (percentage >= 50) {
        bar.className = 'h-full bg-gradient-to-r from-yellow-500 to-orange-500 transition-all duration-500 flex items-center justify-center text-white font-bold text-sm';
        status.textContent = `✓ Você gastou ${percentage.toFixed(1)}% do orçamento`;
        status.className = 'text-sm text-gray-600 dark:text-gray-300 mt-2 text-center font-medium';
        barText.textContent = `${percentage.toFixed(0)}%`;
        document.getElementById('budgetRemaining').classList.add('text-green-700', 'dark:text-green-300');
        document.getElementById('budgetRemaining').classList.remove('text-orange-700', 'dark:text-orange-300', 'text-red-700', 'dark:text-red-300');
    } else {
        bar.className = 'h-full bg-gradient-to-r from-green-500 to-blue-500 transition-all duration-500 flex items-center justify-center text-white font-bold text-sm';
        status.textContent = `✓ Está indo bem! ${(100 - percentage).toFixed(1)}% do orçamento ainda disponível`;
        status.className = 'text-sm text-green-600 dark:text-green-400 mt-2 text-center font-semibold';
        barText.textContent = percentage > 10 ? `${percentage.toFixed(0)}%` : '';
        document.getElementById('budgetRemaining').classList.add('text-green-700', 'dark:text-green-300');
        document.getElementById('budgetRemaining').classList.remove('text-orange-700', 'dark:text-orange-300', 'text-red-700', 'dark:text-red-300');
    }
}

// ===== MODO ESCURO =====

function initDarkMode() {
    const darkMode = localStorage.getItem('darkMode');
    const html = document.documentElement;
    const moonIcon = document.getElementById('moonIcon');
    const sunIcon = document.getElementById('sunIcon');
    
    if (darkMode === null || darkMode === 'false') {
        html.classList.remove('dark');
        moonIcon.classList.remove('hidden');
        sunIcon.classList.add('hidden');
    } else {
        html.classList.add('dark');
        moonIcon.classList.add('hidden');
        sunIcon.classList.remove('hidden');
    }
}

document.getElementById('darkModeToggle').addEventListener('click', function() {
    const html = document.documentElement;
    const moonIcon = document.getElementById('moonIcon');
    const sunIcon = document.getElementById('sunIcon');
    
    html.classList.toggle('dark');
    const isDark = html.classList.contains('dark');
    
    if (isDark) {
        moonIcon.classList.add('hidden');
        sunIcon.classList.remove('hidden');
    } else {
        moonIcon.classList.remove('hidden');
        sunIcon.classList.add('hidden');
    }
    
    localStorage.setItem('darkMode', isDark.toString());
    updateCategoryChart();
    updateDailyChart();
});

// ===== GERENCIAMENTO DE GASTOS =====

function loadExpenses() {
    try {
        const stored = localStorage.getItem('expenses');
        if (stored) {
            expenses = JSON.parse(stored);
        }
    } catch (error) {
        console.error('Erro ao carregar gastos:', error);
        expenses = [];
    }
}

function saveExpenses() {
    try {
        localStorage.setItem('expenses', JSON.stringify(expenses));
    } catch (error) {
        console.error('Erro ao salvar gastos:', error);
    }
}

const expenseForm = document.getElementById('expenseForm');

if (expenseForm) {
    expenseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const description = document.getElementById('description').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        const category = document.getElementById('category').value;
        const date = document.getElementById('date').value;

        if (!description || isNaN(amount) || amount <= 0 || !category || !date) {
            alert('Por favor, preencha todos os campos corretamente!');
            return;
        }

        const expense = {
            id: Date.now(),
            description: description,
            amount: amount,
            category: category,
            date: date
        };

        expenses.push(expense);
        saveExpenses();
        updateAll();
        
        this.reset();
        const today = new Date();
        document.getElementById('date').value = today.toISOString().split('T')[0];
        
        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Adicionado!';
        const originalClasses = btn.className;
        btn.className = btn.className.replace(/from-\S+/g, 'from-green-600').replace(/to-\S+/g, 'to-green-700');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.className = originalClasses;
        }, 2000);
    });
}

window.deleteExpense = function(id) {
    if (confirm('Deseja realmente excluir este gasto?')) {
        expenses = expenses.filter(e => e.id !== id);
        saveExpenses();
        updateAll();
    }
};

// ===== ATUALIZAÇÃO DE RESUMOS =====

function updateSummary() {
    const total = expenses.reduce((sum, e) => sum + e.amount, 0);
    document.getElementById('totalExpense').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;

    const now = new Date();
    const thisMonth = expenses.filter(e => {
        const expenseDate = new Date(e.date + 'T00:00:00');
        return expenseDate.getMonth() === now.getMonth() && 
               expenseDate.getFullYear() === now.getFullYear();
    }).reduce((sum, e) => sum + e.amount, 0);
    document.getElementById('monthExpense').textContent = `R$ ${thisMonth.toFixed(2).replace('.', ',')}`;

    const today = now.toISOString().split('T')[0];
    const todayTotal = expenses.filter(e => e.date === today).reduce((sum, e) => sum + e.amount, 0);
    document.getElementById('todayExpense').textContent = `R$ ${todayTotal.toFixed(2).replace('.', ',')}`;
}

// ===== GRÁFICOS =====

function updateCategoryChart() {
    const categories = {};
    expenses.forEach(e => {
        categories[e.category] = (categories[e.category] || 0) + e.amount;
    });

    const ctx = document.getElementById('categoryChart');
    const isDark = document.documentElement.classList.contains('dark');
    
    if (categoryChart) categoryChart.destroy();

    if (Object.keys(categories).length === 0) {
        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Sem dados'],
                datasets: [{
                    data: [1],
                    backgroundColor: [isDark ? '#4B5563' : '#E5E7EB'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: {
                            color: isDark ? '#F9FAFB' : '#111827',
                            padding: 15,
                            font: { size: 13, weight: 'bold' }
                        }
                    }
                }
            }
        });
        return;
    }

    categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(categories),
            datasets: [{
                data: Object.values(categories),
                backgroundColor: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#14B8A6'],
                borderWidth: 3,
                borderColor: isDark ? '#1F2937' : '#ffffff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        color: isDark ? '#F9FAFB' : '#111827',
                        padding: 15,
                        font: { size: 13, weight: 'bold' }
                    }
                }
            }
        }
    });
}

function updateDailyChart() {
    const last7Days = [];
    const dailyExpenses = {};

    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        last7Days.push(dateStr);
        dailyExpenses[dateStr] = 0;
    }

    expenses.forEach(e => {
        if (dailyExpenses.hasOwnProperty(e.date)) {
            dailyExpenses[e.date] += e.amount;
        }
    });

    const ctx = document.getElementById('dailyChart');
    const isDark = document.documentElement.classList.contains('dark');
    
    if (dailyChart) dailyChart.destroy();

    dailyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: last7Days.map(d => {
                const date = new Date(d + 'T00:00:00');
                return date.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' });
            }),
            datasets: [{
                label: 'Gastos (R$)',
                data: last7Days.map(d => dailyExpenses[d]),
                backgroundColor: isDark ? '#8B5CF6' : '#6366F1',
                borderRadius: 8,
                borderWidth: 2,
                borderColor: isDark ? '#A78BFA' : '#818CF8'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: {
                        color: isDark ? '#F9FAFB' : '#111827',
                        font: { size: 12, weight: 'bold' },
                        callback: value => 'R$ ' + value.toFixed(0)
                    },
                    grid: { color: isDark ? '#374151' : '#E5E7EB', drawBorder: false }
                },
                x: {
                    ticks: { color: isDark ? '#F9FAFB' : '#111827', font: { size: 12, weight: 'bold' } },
                    grid: { display: false }
                }
            },
            plugins: {
                legend: { labels: { color: isDark ? '#F9FAFB' : '#111827', font: { size: 13, weight: 'bold' } } }
            }
        }
    });
}

// ===== CALENDÁRIO =====

function updateCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    document.getElementById('currentMonth').textContent = 
        currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const calendarDays = document.getElementById('calendarDays');
    calendarDays.innerHTML = '';

    for (let i = 0; i < firstDay; i++) {
        calendarDays.innerHTML += '<div></div>';
    }

    const today = new Date().toISOString().split('T')[0];
    const isDark = document.documentElement.classList.contains('dark');
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayExpenses = expenses.filter(e => e.date === dateStr);
        const total = dayExpenses.reduce((sum, e) => sum + e.amount, 0);
        const isToday = dateStr === today;

        let dayClass = '';
        if (isToday) {
            dayClass = isDark ? 'bg-indigo-900 border-2 border-indigo-400 text-white' : 'bg-indigo-100 border-2 border-indigo-600 text-gray-900';
        } else if (total > 0) {
            dayClass = isDark ? 'bg-red-900/60 border-2 border-red-600 text-white' : 'bg-red-50 border-2 border-red-400 text-gray-900';
        } else {
            dayClass = isDark ? 'bg-gray-700 border border-gray-600 text-gray-200' : 'bg-gray-50 border border-gray-300 text-gray-900';
        }
        
        const dayDiv = document.createElement('div');
        dayDiv.className = `${dayClass} rounded-lg p-2 cursor-pointer hover:scale-105 hover:shadow-md transition-all duration-200`;
        dayDiv.onclick = () => showDayExpenses(dateStr);
        dayDiv.innerHTML = `
            <div class="font-bold text-center">${day}</div>
            ${total > 0 ? `<div class="text-xs font-bold text-center mt-1 ${isDark ? 'text-red-300' : 'text-red-700'}">R$ ${total.toFixed(0)}</div>` : ''}
        `;
        calendarDays.appendChild(dayDiv);
    }
}

document.getElementById('prevMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    updateCalendar();
});

document.getElementById('nextMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    updateCalendar();
});

// ===== MODAL DE DIA =====

window.showDayExpenses = function(date) {
    const dayExpenses = expenses.filter(e => e.date === date);
    const dateObj = new Date(date + 'T00:00:00');
    const dayOfWeek = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
    const dayFormatted = dateObj.toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
    
    document.getElementById('modalDayTitle').textContent = dayFormatted;
    document.getElementById('modalDaySubtitle').textContent = dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1);
    
    const total = dayExpenses.reduce((sum, e) => sum + e.amount, 0);
    document.getElementById('modalDayTotal').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
    
    const modalContent = document.getElementById('modalDayExpenses');
    
    if (dayExpenses.length === 0) {
        modalContent.innerHTML = `
            <div class="text-center py-12">
                <p class="text-gray-600 dark:text-gray-300 text-lg font-semibold mb-2">Nenhum gasto neste dia</p>
                <p class="text-gray-500 dark:text-gray-400 text-sm">Este dia está livre de gastos!</p>
            </div>
        `;
    } else {
        const byCategory = {};
        dayExpenses.forEach(e => {
            if (!byCategory[e.category]) byCategory[e.category] = [];
            byCategory[e.category].push(e);
        });
        
        modalContent.innerHTML = Object.keys(byCategory).map(category => {
            const categoryExpenses = byCategory[category];
            const categoryTotal = categoryExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            return `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-bold text-gray-900 dark:text-white">${category}</h4>
                        <span class="text-lg font-bold text-indigo-600 dark:text-indigo-400">R$ ${categoryTotal.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="space-y-2">
                        ${categoryExpenses.map(e => `
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 flex justify-between items-center">
                                <span class="text-gray-900 dark:text-white font-medium">${e.description}</span>
                                <div class="flex items-center gap-3">
                                    <span class="text-gray-900 dark:text-white font-bold">R$ ${e.amount.toFixed(2).replace('.', ',')}</span>
                                    <button onclick="deleteExpenseFromModal(${e.id})" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200 font-bold">✕</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    document.getElementById('dayModal').classList.remove('hidden');
};

window.closeDayModal = () => document.getElementById('dayModal').classList.add('hidden');

window.deleteExpenseFromModal = function(id) {
    if (confirm('Deseja realmente excluir este gasto?')) {
        expenses = expenses.filter(e => e.id !== id);
        saveExpenses();
        
        const currentDate = document.getElementById('modalDayTitle').textContent;
        const dateMatch = currentDate.match(/(\d+) de (\w+) de (\d+)/);
        if (dateMatch) {
            const months = {
                'janeiro': '01', 'fevereiro': '02', 'março': '03', 'abril': '04',
                'maio': '05', 'junho': '06', 'julho': '07', 'agosto': '08',
                'setembro': '09', 'outubro': '10', 'novembro': '11', 'dezembro': '12'
            };
            const day = dateMatch[1].padStart(2, '0');
            const month = months[dateMatch[2]];
            const year = dateMatch[3];
            const dateStr = `${year}-${month}-${day}`;
            showDayExpenses(dateStr);
        }
        
        updateAll();
    }
};

document.getElementById('dayModal').addEventListener('click', function(e) {
    if (e.target === this) closeDayModal();
});

// ===== LISTA DE GASTOS =====

function updateExpenseList() {
    const list = document.getElementById('expenseList');
    
    if (expenses.length === 0) {
        list.innerHTML = `
            <div class="text-center py-12">
                <p class="text-gray-600 dark:text-gray-300 text-lg font-semibold mb-2">Nenhum gasto cadastrado ainda</p>
                <p class="text-gray-500 dark:text-gray-400 text-sm">Adicione seu primeiro gasto acima!</p>
            </div>
        `;
        return;
    }
    
    const sorted = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

    list.innerHTML = sorted.map(e => `
        <div class="border-2 border-gray-200 dark:border-gray-600 rounded-xl p-4 flex justify-between items-center hover:bg-indigo-50 dark:hover:bg-indigo-900/30 bg-white dark:bg-gray-700 transition-all duration-300 hover:scale-[1.02] hover:shadow-md">
            <div class="flex-1">
                <div class="font-bold text-gray-900 dark:text-white text-lg">${e.description}</div>
                <div class="text-sm text-gray-700 dark:text-gray-300 mt-1 font-medium">
                    <span class="bg-indigo-100 dark:bg-indigo-900 px-3 py-1 rounded-lg text-gray-900 dark:text-white">${e.category}</span>
                    <span class="ml-2 text-gray-600 dark:text-gray-300">${new Date(e.date + 'T00:00:00').toLocaleDateString('pt-BR')}</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span class="font-bold text-2xl text-red-700 dark:text-red-300">R$ ${e.amount.toFixed(2).replace('.', ',')}</span>
                <button onclick="deleteExpense(${e.id})" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200 text-xl transition-all duration-300 hover:scale-125 font-bold">✕</button>
            </div>
        </div>
    `).join('');
}

// ===== ATUALIZAR TUDO =====

function updateAll() {
    updateSummary();
    updateBudgetDisplay();
    updateCategoryChart();
    updateDailyChart();
    updateCalendar();
    updateExpenseList();
}

// ===== INICIALIZAÇÃO =====

window.addEventListener('DOMContentLoaded', function() {
    initDarkMode();
    
    const today = new Date();
    document.getElementById('date').value = today.toISOString().split('T')[0];
    
    loadExpenses();
    loadBudget();
    updateAll();
});
    </script>
</body>
</html>