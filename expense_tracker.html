<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">üí∞ Controle de Gastos</h1>
        
        <!-- Formul√°rio de Adicionar Gasto -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Adicionar Gasto</h2>
            <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <input type="text" id="description" placeholder="Descri√ß√£o" required 
                       class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" id="amount" placeholder="Valor (R$)" step="0.01" required 
                       class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="category" required 
                        class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Categoria</option>
                    <option value="Alimenta√ß√£o">üçî Alimenta√ß√£o</option>
                    <option value="Transporte">üöó Transporte</option>
                    <option value="Sa√∫de">üè• Sa√∫de</option>
                    <option value="Lazer">üéÆ Lazer</option>
                    <option value="Educa√ß√£o">üìö Educa√ß√£o</option>
                    <option value="Moradia">üè† Moradia</option>
                    <option value="Outros">üì¶ Outros</option>
                </select>
                <input type="date" id="date" required 
                       class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" 
                        class="bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg px-6 py-2 transition duration-200">
                    Adicionar
                </button>
            </form>
        </div>

        <!-- Resumo de Gastos -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-gray-600 text-sm font-semibold mb-2">Total Gasto</h3>
                <p class="text-3xl font-bold text-red-600" id="totalExpense">R$ 0,00</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-gray-600 text-sm font-semibold mb-2">Gastos Este M√™s</h3>
                <p class="text-3xl font-bold text-orange-600" id="monthExpense">R$ 0,00</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-gray-600 text-sm font-semibold mb-2">Gastos Hoje</h3>
                <p class="text-3xl font-bold text-yellow-600" id="todayExpense">R$ 0,00</p>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Gastos por Categoria</h3>
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Gastos por Dia (√öltimos 7 dias)</h3>
                <canvas id="dailyChart"></canvas>
            </div>
        </div>

        <!-- Calend√°rio e Lista de Gastos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Calend√°rio -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Calend√°rio de Gastos</h3>
                <div id="calendar" class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prevMonth" class="bg-gray-200 hover:bg-gray-300 rounded-lg px-4 py-2">‚óÄ</button>
                        <h4 id="currentMonth" class="text-lg font-semibold"></h4>
                        <button id="nextMonth" class="bg-gray-200 hover:bg-gray-300 rounded-lg px-4 py-2">‚ñ∂</button>
                    </div>
                    <div class="grid grid-cols-7 gap-2 text-center">
                        <div class="font-semibold text-gray-600">Dom</div>
                        <div class="font-semibold text-gray-600">Seg</div>
                        <div class="font-semibold text-gray-600">Ter</div>
                        <div class="font-semibold text-gray-600">Qua</div>
                        <div class="font-semibold text-gray-600">Qui</div>
                        <div class="font-semibold text-gray-600">Sex</div>
                        <div class="font-semibold text-gray-600">S√°b</div>
                    </div>
                    <div id="calendarDays" class="grid grid-cols-7 gap-2 text-center mt-2"></div>
                </div>
            </div>

            <!-- Lista de Gastos -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Lista de Gastos</h3>
                <div id="expenseList" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        // Estado global
        let expenses = [];
        let currentDate = new Date();
        let categoryChart = null;
        let dailyChart = null;

        // Fun√ß√£o para carregar gastos
        function loadExpenses() {
            try {
                const stored = localStorage.getItem('expenses');
                if (stored) {
                    expenses = JSON.parse(stored);
                    console.log('Gastos carregados:', expenses);
                }
            } catch (error) {
                console.error('Erro ao carregar gastos:', error);
                expenses = [];
            }
        }

        // Fun√ß√£o para salvar gastos
        function saveExpenses() {
            try {
                localStorage.setItem('expenses', JSON.stringify(expenses));
                console.log('Gastos salvos:', expenses);
            } catch (error) {
                console.error('Erro ao salvar gastos:', error);
            }
        }

        // Adicionar gasto - COM DEBUG
        const form = document.getElementById('expenseForm');
        console.log('Formul√°rio encontrado:', form);
        
        form.addEventListener('submit', function(e) {
            console.log('=== SUBMIT DISPARADO ===');
            e.preventDefault();
            
            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const date = document.getElementById('date').value;

            console.log('Valores capturados:', { description, amount, category, date });

            if (!description || !amount || !category || !date) {
                console.error('Campos faltando!');
                alert('Por favor, preencha todos os campos!');
                return;
            }

            const expense = {
                id: Date.now(),
                description: description,
                amount: amount,
                category: category,
                date: date
            };

            console.log('Objeto expense criado:', expense);
            console.log('Array expenses ANTES:', expenses);
            
            expenses.push(expense);
            
            console.log('Array expenses DEPOIS:', expenses);
            
            saveExpenses();
            updateAll();
            
            // Limpar formul√°rio
            this.reset();
            
            // Redefine a data para hoje
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${year}-${month}-${day}`;
            
            console.log('=== GASTO ADICIONADO COM SUCESSO ===');
            alert('Gasto adicionado com sucesso!');
        });

        // Deletar gasto
        window.deleteExpense = function(id) {
            if (confirm('Deseja realmente excluir este gasto?')) {
                expenses = expenses.filter(e => e.id !== id);
                saveExpenses();
                updateAll();
            }
        };

        // Atualizar resumo
        function updateSummary() {
            const total = expenses.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('totalExpense').textContent = `R$ ${total.toFixed(2)}`;

            const now = new Date();
            const thisMonth = expenses.filter(e => {
                const expenseDate = new Date(e.date + 'T00:00:00');
                return expenseDate.getMonth() === now.getMonth() && 
                       expenseDate.getFullYear() === now.getFullYear();
            }).reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('monthExpense').textContent = `R$ ${thisMonth.toFixed(2)}`;

            const today = now.toISOString().split('T')[0];
            const todayTotal = expenses.filter(e => e.date === today).reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('todayExpense').textContent = `R$ ${todayTotal.toFixed(2)}`;
        }

        // Atualizar gr√°fico de categorias
        function updateCategoryChart() {
            const categories = {};
            expenses.forEach(e => {
                categories[e.category] = (categories[e.category] || 0) + e.amount;
            });

            const ctx = document.getElementById('categoryChart');
            
            if (categoryChart) {
                categoryChart.destroy();
            }

            if (Object.keys(categories).length === 0) {
                categoryChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Sem dados'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#E5E7EB']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
                return;
            }

            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Atualizar gr√°fico di√°rio
        function updateDailyChart() {
            const last7Days = [];
            const dailyExpenses = {};

            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                last7Days.push(dateStr);
                dailyExpenses[dateStr] = 0;
            }

            expenses.forEach(e => {
                if (dailyExpenses.hasOwnProperty(e.date)) {
                    dailyExpenses[e.date] += e.amount;
                }
            });

            const ctx = document.getElementById('dailyChart');
            
            if (dailyChart) {
                dailyChart.destroy();
            }

            dailyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: last7Days.map(d => {
                        const date = new Date(d + 'T00:00:00');
                        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    }),
                    datasets: [{
                        label: 'Gastos (R$)',
                        data: last7Days.map(d => dailyExpenses[d]),
                        backgroundColor: '#3B82F6'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Atualizar calend√°rio
        function updateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            // Dias vazios
            for (let i = 0; i < firstDay; i++) {
                calendarDays.innerHTML += '<div></div>';
            }

            // Dias do m√™s
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayExpenses = expenses.filter(e => e.date === dateStr);
                const total = dayExpenses.reduce((sum, e) => sum + e.amount, 0);

                const dayClass = total > 0 ? 'bg-red-100 border-red-300' : 'bg-gray-50';
                const dayDiv = document.createElement('div');
                dayDiv.className = `border ${dayClass} rounded-lg p-2 cursor-pointer hover:bg-blue-50`;
                dayDiv.onclick = () => showDayExpenses(dateStr);
                dayDiv.innerHTML = `
                    <div class="font-semibold">${day}</div>
                    ${total > 0 ? `<div class="text-xs text-red-600">R$ ${total.toFixed(0)}</div>` : ''}
                `;
                calendarDays.appendChild(dayDiv);
            }
        }

        // Mostrar gastos do dia
        window.showDayExpenses = function(date) {
            const dayExpenses = expenses.filter(e => e.date === date);
            if (dayExpenses.length === 0) {
                alert('Nenhum gasto neste dia');
                return;
            }
            
            const formatted = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
            const list = dayExpenses.map(e => 
                `${e.description}: R$ ${e.amount.toFixed(2)} (${e.category})`
            ).join('\n');
            
            alert(`Gastos em ${formatted}:\n\n${list}`);
        };

        // Atualizar lista de gastos
        function updateExpenseList() {
            const list = document.getElementById('expenseList');
            
            if (expenses.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum gasto cadastrado ainda</p>';
                return;
            }
            
            const sorted = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            list.innerHTML = sorted.map(e => `
                <div class="border border-gray-200 rounded-lg p-3 flex justify-between items-center hover:bg-gray-50">
                    <div>
                        <div class="font-semibold">${e.description}</div>
                        <div class="text-sm text-gray-600">${e.category} ‚Ä¢ ${new Date(e.date + 'T00:00:00').toLocaleDateString('pt-BR')}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-red-600">R$ ${e.amount.toFixed(2)}</span>
                        <button onclick="deleteExpense(${e.id})" class="text-red-500 hover:text-red-700 text-xl">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // Navega√ß√£o do calend√°rio
        document.getElementById('prevMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendar();
        });

        // Atualizar tudo
        function updateAll() {
            updateSummary();
            updateCategoryChart();
            updateDailyChart();
            updateCalendar();
            updateExpenseList();
        }

        // Inicializar ao carregar a p√°gina
        window.addEventListener('DOMContentLoaded', function() {
            console.log('P√°gina carregada, inicializando...');
            
            // Definir data de hoje no campo
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${year}-${month}-${day}`;
            
            // Carregar dados e atualizar interface
            loadExpenses();
            updateAll();
            
            console.log('Inicializa√ß√£o completa!');
        });
    </script>
</body>
</html>